<div class="w-container">
  <div class="auth-container">
    <img src="https://espensivo.com/images/icon128.png" alt="Espensivo Logo" class="auth-logo">
    <h1 class="auth-title">Completing Sign In</h1>
    <p class="auth-message">Please wait while we verify your sign-in...</p>
    <div class="auth-spinner"></div>
    <button class="auth-button" style="display: none;">Open Espensivo</button>
    <p class="auth-error"></p>
  </div>
</div>

<style>
.auth-container {
  text-align: center;
  padding: 2rem;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  max-width: 400px;
  width: 90%;
  margin: 100px auto;
}
.auth-logo {
  width: 64px;
  height: 64px;
  margin-bottom: 1.5rem;
}
.auth-title {
  margin: 0 0 1rem 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #1f2937;
}
.auth-message {
  color: #6b7280;
  margin-bottom: 1rem;
  line-height: 1.5;
}
.auth-error {
  color: #dc2626;
  margin-top: 1rem;
  display: none;
  line-height: 1.5;
}
.auth-spinner {
  border: 3px solid #f3f3f3;
  border-radius: 50%;
  border-top: 3px solid #2563eb;
  width: 24px;
  height: 24px;
  margin: 20px auto;
  animation: spin 1s linear infinite;
}
.auth-button {
  display: none;
  background: #2563eb;
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 6px;
  font-weight: 500;
  border: none;
  cursor: pointer;
  font-size: 1rem;
  margin: 1rem auto;
  transition: background-color 0.2s;
}
.auth-button:hover {
  background: #1d4ed8;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.success .auth-title {
  color: #059669;
}
.success .auth-message {
  color: #047857;
}
</style>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, isSignInWithEmailLink } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  const firebaseConfig = {
    apiKey: "AIzaSyAHP9_XPQE3Y2kKAHscnoYLUDyYoBPKqYc",
    authDomain: "espensivo.firebaseapp.com",
    projectId: "espensivo",
    storageBucket: "espensivo.appspot.com",
    messagingSenderId: "282331992610",
    appId: "1:282331992610:web:06ecf1fb019f24427c307b"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  async function handleAuthCallback() {
    try {
      // Get the full URL
      const url = window.location.href;
      
      if (isSignInWithEmailLink(auth, url)) {
        // Show the button to open extension
        document.querySelector('.auth-spinner').style.display = 'none';
        document.querySelector('.auth-container').classList.add('success');
        document.querySelector('.auth-title').textContent = 'Almost Done!';
        document.querySelector('.auth-message').textContent = 'Click below to open Espensivo and complete your sign-in.';
        
        // Show the button
        const button = document.querySelector('.auth-button');
        button.style.display = 'inline-block';
        button.addEventListener('click', () => {
          const extensionId = 'kaijibinmccffbklpdpfchdmopjmlden';
          // Send message to extension's background script
          chrome.runtime.sendMessage(extensionId, {
            type: 'complete_auth',
            url: window.location.href
          }, (response) => {
            if (response && response.success) {
              document.querySelector('.auth-message').textContent = 'Successfully signed in! You can now close this page.';
            } else {
              document.querySelector('.auth-error').textContent = 'Failed to complete sign-in. Please try again.';
              document.querySelector('.auth-error').style.display = 'block';
            }
          });
        });
      }
    } catch (error) {
      console.error('Error:', error);
      document.querySelector('.auth-spinner').style.display = 'none';
      document.querySelector('.auth-error').textContent = error.message;
      document.querySelector('.auth-error').style.display = 'block';
    }
  }

  // Initialize when the page loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', handleAuthCallback);
  } else {
    handleAuthCallback();
  }
</script>